// Generated by CoffeeScript 2.1.1
(function() {
  var express, formidable, fs, path, router;

  fs = require('fs');

  path = require('path');

  express = require('express');

  router = express.Router();

  formidable = require('formidable');

  router.get('/iphone-uploading', function(req, res, next) {
    return res.render('uploading/iphone-uploading');
  });

  router.post('/iphone-uploading', function(req, res, next) {
    var form, ifred;
    form = new formidable.IncomingForm;
    form.uploadDir = path.join(path.dirname(__dirname), 'tmp');
    form.multiples = true;
    ifred = false;
    form.on('file', function(name, file) {
      var abs, prefix, suffix;
      // abs is 'absolute path string'
      prefix = file.path.slice(0, file.path.lastIndexOf('/'));
      suffix = file.name;
      abs = path.join(prefix, suffix);
      return fs.rename(file.path, abs, function(err) {
        if (err) {
          throw new Error('rename event occurs error.');
        }
        console.log('-------');
        console.log('move path:"%s" to "%s".', file.path, abs);
        return console.log('-------');
      });
    });
    return form.parse(req, function(err) {
      if (err) {
        return res.render('uploading/error.pug');
      } else {
        return res.redirect(302, '/uploading/successfully'); // 302 is default code.
      }
    });
  });

  router.get('/successfully', function(req, res, next) {
    return res.render('uploading/successfully', {
      title: 'iphone-uploading-success'
    });
  });

  module.exports = router;

}).call(this);
