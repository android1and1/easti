// Generated by CoffeeScript 2.3.1
(function() {
  // 2018-12-19 game is "5min=1app". 
  var client, express, neighborCarFactory, nohm, router, schema;

  express = require('express');

  router = express.Router();

  nohm = void 0;

  schema = void 0;

  client = (require('redis')).createClient();

  client.on('error', function(error) {
    return console.log('::debug info - route neighborCar::', error.message);
  });

  client.on('connect', function() {
    var md;
    md = require('../modules/md-neighborCar');
    nohm = (require('nohm')).Nohm;
    nohm.setPrefix('gaikai');
    nohm.setClient(this);
    return schema = nohm.register(md);
  });

  // till here,has 'global' variable - '' 
  router.get('/', function(req, res, next) {
    return res.redirect(302, '/neighborCar/list');
  });

  router.get('/list', async function(req, res, next) {
    var allids, allitems, i, ins, j, len;
    // top10 sorted by id number.
    allids = (await schema.sort({
      field: 'whatistime',
      direction: 'DESC',
      limit: [0, 10]
    }));
    allitems = [];
    for (j = 0, len = allids.length; j < len; j++) {
      i = allids[j];
      ins = (await nohm.factory('neighborCar', i));
      allitems.push(ins.allProperties());
    }
    return res.render('neighborCar/list.pug', {
      top10: allitems
    });
  });

  router.post('/find-by-vehicle-model', async function(req, res, next) {
    var error, info, item, items, j, len, vehicle_model;
    vehicle_model = req.body.keyword;
    info = [];
    try {
      items = (await schema.findAndLoad({
        'vehicle_model': vehicle_model
      }));
      for (j = 0, len = items.length; j < len; j++) {
        item = items[j];
        info.push(item.allProperties());
      }
    } catch (error1) {
      error = error1;
      return res.json({
        'error': 'No This Vehicle Model.'
      });
    }
    return res.json(info);
  });

  router.post('/find-by-color', async function(req, res, next) {
    var color, error, info, item, items, j, len;
    color = req.body.keyword;
    info = [];
    try {
      items = (await schema.findAndLoad({
        'color': color
      }));
      for (j = 0, len = items.length; j < len; j++) {
        item = items[j];
        info.push(item.allProperties());
      }
    } catch (error1) {
      error = error1;
      return res.json({
        'error': 'No This Color.'
      });
    }
    return res.json(info);
  });

  router.post('/find-by-brand', async function(req, res, next) {
    var brand, error, item, items, j, len, list;
    brand = req.body.keyword;
    list = [];
    try {
      items = (await schema.findAndLoad({
        'brand': brand
      }));
      for (j = 0, len = items.length; j < len; j++) {
        item = items[j];
        item.property('visits', '');
        await item.save();
        list.push(item.allProperties());
      }
    } catch (error1) {
      error = error1;
      return res.json({
        'error': 'No This Brand.'
      });
    }
    return res.render('neighborCar/results-list', {
      list: list
    });
  });

  router.get('/register-car', function(req, res, next) {
    return res.render('neighborCar/register-car.pug', {
      title: 'Register Car(Neighbors)'
    });
  });

  router.get('/update/:id', async function(req, res, next) {
    var id, item, properties;
    id = req.param.id;
    try {
      item = (await nohm.factory('neighborCar', id));
      properties = item.allProperties();
      return res.render('neighborCar/base-item-form.pug', {
        title: 'Update Car',
        properties: properties
      });
    } catch (error1) {}
  });

  router.get('/purge-db', function(req, res, next) {
    return res.render('neighborCar/purge-db.pug');
  });

  router.delete('/purge-db', async function(req, res, next) {
    var error;
    // quanteetee user from '/neighborCar/purge-db'(GET),click button.
    if (req.xhr) {
      try {
        await nohm.purgeDb(client);
      } catch (error1) {
        error = error1;
        return res.send('purge execution failed. all.');
      }
      return res.send('purge all itmes in db:wiki.');
    } else {
      return res.send('nosense!');
    }
  });

  // add!
  router.post('/register-car', async function(req, res, next) {
    var body, error, ins;
    ins = (await nohm.factory('neighborCar'));
    body = req.body;
    ins.property('visits', 1);
    ins.property({
      brand: body.brand,
      licence_number: body.licence_number,
      color: body.color,
      vehicle_model: body.vehicle_model,
      whatistime: Date.parse(new Date),
      where_seen: body.where_seen,
      memo: body.memo
    });
    try {
      await ins.save();
    } catch (error1) {
      error = error1;
      console.log(ins.errors);
      return res.send('save failed.');
    }
    return res.send('saved.');
  });

  neighborCarFactory = function(app) {
    return function(pathname) {
      return app.use(pathname, router);
    };
  };

  module.exports = neighborCarFactory;

}).call(this);
