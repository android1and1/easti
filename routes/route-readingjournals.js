// Generated by CoffeeScript 2.1.1
(function() {
  var Nohm, RT, Redis, express, formidable, fs, nohm, nohm2, path, pug, router;

  fs = require('fs');

  pug = require('pug');

  path = require('path');

  express = require('express');

  router = express.Router();

  formidable = require('formidable');

  Redis = require('redis');

  RT = require('../modules/md-readingjournals');

  Nohm = require('nohm');

  [nohm, nohm2] = [Nohm.Nohm, Nohm.Nohm];

  [nohm, nohm2].forEach(function(itisnohm) {
    var redis;
    // now we have 2 redis clients.
    redis = Redis.createClient();
    redis.on('error', function(err) {
      return console.log('debug info::route-readingjournals::', err.message);
    });
    return redis.on('connect', function() {
      itisnohm.setClient(redis);
      return itisnohm.setPrefix('seesee');
    });
  });

  router.get('/', function(req, res, next) {
    return res.render('readingjournals/index', {
      title: 'i am journals'
    });
  });

  router.get('/sample-mod2form', function(req, res, next) {
    var opts, snippet, url;
    opts = RT.definitions;
    url = 'http://www.fellow5.cn';
    snippet = pug.render(RT.mod2form(), {
      opts: opts,
      url: url
    });
    return res.render('readingjournals/tianna', {
      snippet: snippet
    });
  });

  // add 
  router.all('/add', async function(req, res, next) {
    var error, ins, opts, ref, ref1, schema, snippet, url;
    if (req.method === 'POST') {
      schema = nohm2.register(RT);
      ins = (await nohm2.factory(RT.modelName));
      ins.property({
        title: req.body.title,
        author: req.body.author,
        visits: ((ref = req.body) != null ? ref.vistis : void 0) || 0,
        reading_history: req.body.reading_history,
        tag: req.body.tag,
        timestamp: ((ref1 = req.body) != null ? ref1.timestamp : void 0) || Date.parse(new Date),
        journal: req.body.journal
      });
      try {
        await ins.save({
          silence: true
        });
      } catch (error1) {
        error = error1;
        if (error instanceof Nohm.ValidationError) {
          console.log('validation error during save().');
        } else {
          console.log(error.message);
        }
        res.json({
          status: 'error',
          reason: 'no save,check abouts.'
        });
      }
      return res.json({
        status: 'ok' // this case is method : 'GET'
      });
    } else {
      opts = RT.definitions;
      url = '/reading-journals/add';
      snippet = pug.render(RT.mod2form(), {
        opts: opts,
        url: url
      });
      return res.render('readingjournals/add.pug', {
        snippet: snippet
      });
    }
  });

  module.exports = router;

}).call(this);
