// Generated by CoffeeScript 2.3.1
(function() {
  var Nohm, RT, Redis, express, fs, nohm1, nohm2, path, pug, router;

  fs = require('fs');

  pug = require('pug');

  path = require('path');

  express = require('express');

  router = express.Router();

  //formidable = require 'formidable'
  Redis = require('redis');

  RT = require('../modules/md-readingjournals');

  Nohm = require('nohm');

  [nohm1, nohm2] = [Nohm.Nohm, Nohm.Nohm];

  [nohm1, nohm2].forEach(function(itisnohm) {
    var redis;
    // now we have 2 redis clients.
    redis = Redis.createClient();
    redis.on('error', function(err) {
      return console.log('debug info::route-readingjournals::', err.message);
    });
    return redis.on('connect', function() {
      itisnohm.setClient(redis);
      return itisnohm.setPrefix('seesee');
    });
  });

  router.get('/', async function(req, res, next) {
    var allids, allins, alljournals, i, ins, len, schema;
    // index page,list all items.
    schema = nohm1.register(RT);
    allids = (await schema.sort({
      'field': 'visits',
      'direction': 'DESC',
      'limit': [0, 11]
    }));
    allins = (await schema.loadMany(allids));
    alljournals = [];
    for (i = 0, len = allins.length; i < len; i++) {
      ins = allins[i];
      alljournals.push(ins.allProperties());
    }
    return res.render('readingjournals/index', {
      title: 'i am journals',
      'alljournals': alljournals
    });
  });

  router.post('/delete/:id', async function(req, res, next) {
    var error, schema, thisid, thisins;
    // at a list page,each item has button named 'Delete It'
    thisid = req.params.id;
    schema = nohm1.register(RT);
    try {
      thisins = (await schema.load(thisid));
      return thisins.remove().then(function() {
        return res.json({
          status: 'delete-ok'
        });
      });
    } catch (error1) {
      error = error1;
      return res.json({
        status: 'delete-error',
        error: error.message
      });
    }
  });

  router.get('/sample-mod2form', function(req, res, next) {
    var opts, snippet, url;
    opts = RT.definitions;
    url = 'http://www.fellow5.cn';
    snippet = pug.render(RT.mod2form(), {
      opts: opts,
      url: url
    });
    return res.render('readingjournals/tianna', {
      snippet: snippet
    });
  });

  // add 
  router.all('/add', async function(req, res, next) {
    var author, error, ins, journal, opts, reading_history, schema, snippet, tag, timestamp, title, url, visits;
    if (req.method === 'POST') {
      schema = nohm2.register(RT);
      ins = (await nohm2.factory(RT.modelName));
      ({title, author, visits, reading_history, tag, timestamp, journal} = req.body);
      // TODO check if value == '',let is abey default value defined in schema.
      if (visits !== '') {
        ins.property('visits', visits);
      }
      if (tag !== '') {
        ins.property('tag', tag);
      }
      if (timestamp !== '') {
        ins.property('timestamp', timestamp);
      }
      if (reading_history !== '') {
        ins.property('reading_history', reading_history);
      }
      ins.property({
        title: title,
        author: author,
        journal: journal
      });
      try {
        await ins.save({
          silence: true
        });
        return res.json({
          status: 'ok'
        });
      } catch (error1) {
        error = error1;
        if (error instanceof Nohm.ValidationError) {
          console.log('validation error during save().');
        } else {
          console.log(error.message);
        }
        return res.json({
          status: 'error',
          reason: 'no save,check abouts.' // this case is method : 'GET'
        });
      }
    } else {
      opts = RT.definitions;
      url = '/reading-journals/add';
      snippet = pug.render(RT.mod2form(), {
        opts: opts,
        url: url
      });
      return res.render('readingjournals/add.pug', {
        snippet: snippet
      });
    }
  });

  module.exports = router;

}).call(this);
