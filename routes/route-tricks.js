// Generated by CoffeeScript 2.3.1
(function() {

  /*
  help methods
  */
  var DB_PREFIX, Redis, TABLE_PREFIX, counter, express, formidable, fs, handArray, handSingle, nohm, path, pug, router, schema;

  fs = require('fs');

  pug = require('pug');

  path = require('path');

  express = require('express');

  router = express.Router();

  formidable = require('formidable');

  Redis = require('redis');

  nohm = (require('nohm')).Nohm;

  schema = require('../modules/sche-tricks.js');

  DB_PREFIX = schema.prefixes[0];

  TABLE_PREFIX = schema.prefixes[1];

  
  //counter
  counter = 0;

  // the first time,express working with nohm - redis orm library
  router.get('/', function(req, res, next) {
    var redis;
    redis = Redis.createClient();
    redis.on('error', function(err) {
      return console.log('debug info::route-tricks::', err.message);
    });
    return redis.on('connect', async function() {
      var i, ids, item, items, j, len;
      nohm.setClient(redis);
      nohm.setPrefix(DB_PREFIX);
      ids = (await schema.find());
      items = [];
      if (ids.length > 0) {
        for (j = 0, len = ids.length; j < len; j++) {
          i = ids[j];
          item = (await schema.load(i));
          items.push(item.allProperties());
        }
        return res.render('tricks/index.pug', {
          length: items.length,
          items: items
        });
      } else {
        return res.render('tricks/index.pug', {
          idle: true
        });
      }
    });
  });

  router.get('/add1', function(req, res, next) {
    return res.render('tricks/add1.pug', {
      order: counter++
    });
  });

  router.post('/add1', function(req, res, next) {
    var redis;
    redis = Redis.createClient();
    redis.on('error', function(err) {
      return console.log('debug info::route-tricks::', err.message);
    });
    return redis.on('connect', async function() {
      /* 
      return res.json 
        'warining':'We Have Not Supports Array-Save Currently.'
        'form-number':req.body.sign
        'body.structure': JSON.stringify req.body
      */
      var check, response;
      nohm.setClient(redis);
      nohm.setPrefix(DB_PREFIX);
      if (req.body.sign === '1') {
        check = (await handSingle(req.body));
        if (check.error) { // has error
          return res.json({
            state: 'Error'
          });
        } else {
          return res.json({
            state: 'Saved'
          });
        }
      } else {
        response = (await handArray(parseInt(req.body.sign), req.body));
        console.log('//////');
        console.log(response);
        console.log('//////');
        return res.send(response.join(''));
      }
    });
  });

  router.post('/onemore', function(req, res, next) {
    //note that,"pug.renderFile" retrieves .pug path,not same as "res.render"
    // res.render works from root directory - "<project>/views"
    return res.send(pug.renderFile('views/tricks/snippet-form.pug', {
      order: counter++
    }));
  });

  handSingle = async function(body) {
    var showtitle, trick, valid;
    trick = (await nohm.factory(TABLE_PREFIX));
    trick.property({
      about: body.about,
      content: body.content,
      visits: body.visits
    });
    valid = (await trick.validate(void 0, false));
    if (!valid) {
      
      //console.dir trick.errors
      // return a promise
      showtitle = 'handle item about "' + body.about + '"';
      return Promise.resolve({
        showtitle: 'failure due database suit'
      });
    } else {
      return trick.save().then(function() {
        showtitle = 'handle item "' + trick.id + ' " completed.';
        return Promise.resolve(showtitle);
      });
    }
  };

  handArray = function(length, body) {
    var allthings;
    allthings = (function() {
      var results = [];
      for (var j = 0; 0 <= length ? j < length : j > length; 0 <= length ? j++ : j--){ results.push(j); }
      return results;
    }).apply(this).map(function(i) {
      return handSingle({
        about: body["about"][i],
        content: body["content"][i],
        visits: body["visits"][i]
      });
    });
    return Promise.all(allthings);
  };

  module.exports = router;

}).call(this);
