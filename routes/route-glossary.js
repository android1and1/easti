// Generated by CoffeeScript 2.3.1
(function() {
  var db, definitions, express, getFields, glossaryFactory, router, sqlite;

  express = require('express');

  router = new express.Router;

  ({definitions, getFields} = require('../modules/md-glossary.js'));

  sqlite = require('sqlite3');

  sqlite.verbose();

  db = new sqlite.Database('sqlitedb/sqlite.sql', function() {
    return db.run(definitions);
  });

  // list
  router.get('/', function(req, res, next) {
    // list top10
    return db.serialize(function() {
      return db.all('select * from glossary limit 10', function(err, arr) {
        if (err === null) {
          return res.render('glossary/index.pug', {
            title: 'top10 list',
            top10: arr
          });
        } else {
          return res.render('glossary/index.pug', {
            title: 'top10 list',
            error: 'database error.'
          });
        }
      });
    });
  });

  
  // add
  router.get('/response', function(req, res, next) {
    return res.render('glossary/response.pug');
  });

  router.get('/add', function(req, res, next) {
    var fields;
    // Notice That,this is dynamiclly created form.
    fields = getFields();
    return res.render('glossary/add.pug', {
      fields: fields
    });
  });

  router.get('/want-update/:id', function(req, res, next) {
    return db.get('select * from glossary where id = ?', req.params.id, function(err, item) {
      if (err) {
        return res.render('glossary/item.pug', {
          title: 'detail page',
          item: void 0
        });
      } else {
        return res.render('glossary/item.pug', {
          title: 'detail page',
          item: item,
          fields: getFields()
        });
      }
    });
  });

  router.post('/updated', function(req, res, next) {});

  router.post('/add', function(req, res, next) {
    var body;
    body = req.body;
    return db.serialize(function() {
      var stmt;
      stmt = db.prepare('insert into glossary (term,about,article,visits,last_visited) values (?,?,?,?,?)');
      stmt.bind(body.term, body.about, body.article, body.visits, body.last_visited);
      stmt.run();
      return stmt.finalize(function() {
        return res.redirect('/glossary/response');
      });
    });
  });

  glossaryFactory = function(app) {
    return function(whichpath) {
      return app.use(whichpath, router);
    };
  };

  module.exports = glossaryFactory;

  /*
  this route map one table: "glossary",its definition at 'modules/md-glossary.js'
  written by a.d
  2018-12-12
*/

}).call(this);
